<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Worker Configuration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        input[type="file"] {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>PDF Worker Configuration Test</h1>
    <p>This page tests the PDF.js worker configuration to ensure PDF processing works correctly.</p>

    <div class="test-section">
        <h2>Environment Information</h2>
        <div id="environment-info"></div>
    </div>

    <div class="test-section">
        <h2>PDF.js Configuration Status</h2>
        <div id="config-status"></div>
        <button onclick="checkConfiguration()">Refresh Configuration Check</button>
    </div>

    <div class="test-section">
        <h2>Worker Source Test</h2>
        <div id="worker-info"></div>
        <button onclick="testWorkerSource()">Test Worker Accessibility</button>
    </div>

    <div class="test-section">
        <h2>PDF Processing Test</h2>
        <p>Upload a PDF file to test if PDF.js can successfully process it:</p>
        <input type="file" id="pdf-file" accept=".pdf" onchange="testPdfProcessing(this.files[0])">
        <div id="pdf-test-result"></div>
    </div>

    <div class="test-section">
        <h2>Test Log</h2>
        <div id="test-log" class="log"></div>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <!-- Load PDF.js and our configuration utility -->
    <script src="js/pdf.min.js"></script>
    <script src="js/pdf-config.js"></script>

    <script>
        // Test utilities
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('test-log');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${getLogColor(type)};">[${type.toUpperCase()}]</span> ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function getLogColor(type) {
            const colors = {
                'info': '#0c5460',
                'success': '#155724',
                'warning': '#856404',
                'error': '#721c24'
            };
            return colors[type] || '#333';
        }

        function clearLog() {
            document.getElementById('test-log').innerHTML = '';
        }

        function showEnvironmentInfo() {
            const info = {
                'Hostname': window.location.hostname,
                'Protocol': window.location.protocol,
                'Port': window.location.port || 'default',
                'Origin': window.location.origin,
                'User Agent': navigator.userAgent.substring(0, 100) + '...',
                'Is Localhost': PDFConfig ? PDFConfig.isLocalEnvironment() : 'PDFConfig not available'
            };

            let html = '<table style="width: 100%; border-collapse: collapse;">';
            for (const [key, value] of Object.entries(info)) {
                html += `<tr><td style="border: 1px solid #ddd; padding: 8px; font-weight: bold;">${key}</td><td style="border: 1px solid #ddd; padding: 8px;">${value}</td></tr>`;
            }
            html += '</table>';

            document.getElementById('environment-info').innerHTML = html;
            log('Environment information displayed');
        }

        function checkConfiguration() {
            const statusDiv = document.getElementById('config-status');
            
            if (typeof PDFConfig === 'undefined') {
                statusDiv.innerHTML = '<div class="status error">❌ PDFConfig utility not loaded</div>';
                log('PDFConfig utility not available', 'error');
                return;
            }

            if (typeof pdfjsLib === 'undefined') {
                statusDiv.innerHTML = '<div class="status error">❌ PDF.js library not loaded</div>';
                log('PDF.js library not loaded', 'error');
                return;
            }

            const validation = PDFConfig.validateSetup();
            const status = PDFConfig.getSetupStatus();
            const workerSrc = PDFConfig.getWorkerSrc();

            let html = `<div class="status ${validation.libraryLoaded && validation.workerConfigured ? 'success' : 'warning'}">${status}</div>`;
            html += '<h4>Validation Details:</h4>';
            html += `<p><strong>Library Loaded:</strong> ${validation.libraryLoaded ? '✅' : '❌'}</p>`;
            html += `<p><strong>Worker Configured:</strong> ${validation.workerConfigured ? '✅' : '❌'}</p>`;
            html += `<p><strong>Worker Accessible:</strong> ${validation.workerAccessible ? '✅' : '❌'}</p>`;
            html += `<p><strong>Worker Source:</strong> <code>${workerSrc || 'Not configured'}</code></p>`;

            statusDiv.innerHTML = html;
            log(`Configuration check completed: ${status}`, validation.libraryLoaded && validation.workerConfigured ? 'success' : 'warning');
        }

        function showWorkerInfo() {
            const infoDiv = document.getElementById('worker-info');
            
            if (typeof PDFConfig === 'undefined' || typeof pdfjsLib === 'undefined') {
                infoDiv.innerHTML = '<div class="status error">PDF.js or PDFConfig not available</div>';
                return;
            }

            const workerSrc = PDFConfig.getWorkerSrc();
            const config = PDFConfig.workerConfig;

            let html = '<h4>Worker Configuration:</h4>';
            html += `<p><strong>Current Worker:</strong> <code>${workerSrc || 'Not set'}</code></p>`;
            html += '<h4>Available Workers:</h4>';
            html += `<p><strong>CDN Worker:</strong> <code>${config.cdnWorkerSrc}</code></p>`;
            html += `<p><strong>Local Worker:</strong> <code>${config.localWorkerSrc}</code></p>`;
            html += `<p><strong>Fallback Worker:</strong> <code>${config.fallbackWorkerSrc}</code></p>`;

            infoDiv.innerHTML = html;
        }

        async function testWorkerSource() {
            if (typeof PDFConfig === 'undefined') {
                log('PDFConfig not available for worker testing', 'error');
                return;
            }

            const workerSrc = PDFConfig.getWorkerSrc();
            if (!workerSrc) {
                log('No worker source configured', 'error');
                return;
            }

            log(`Testing worker accessibility: ${workerSrc}`, 'info');

            try {
                if (workerSrc.startsWith('http')) {
                    // For HTTP(S) workers, try to fetch the resource
                    const response = await fetch(workerSrc, { method: 'HEAD' });
                    if (response.ok) {
                        log('✅ Worker source is accessible via HTTP', 'success');
                    } else {
                        log(`❌ Worker source returned HTTP ${response.status}`, 'error');
                    }
                } else {
                    // For local workers, we can't easily test without CORS issues
                    log('ℹ️ Local worker path detected - accessibility depends on server configuration', 'info');
                }
            } catch (error) {
                log(`❌ Worker accessibility test failed: ${error.message}`, 'error');
            }
        }

        async function testPdfProcessing(file) {
            const resultDiv = document.getElementById('pdf-test-result');
            
            if (!file) {
                resultDiv.innerHTML = '<div class="status warning">No file selected</div>';
                return;
            }

            if (file.type !== 'application/pdf') {
                resultDiv.innerHTML = '<div class="status error">Please select a PDF file</div>';
                log('Invalid file type selected', 'error');
                return;
            }

            resultDiv.innerHTML = '<div class="status info">Processing PDF file...</div>';
            log(`Starting PDF processing test with file: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`, 'info');

            try {
                // Check if PDF.js is properly configured
                if (typeof pdfjsLib === 'undefined') {
                    throw new Error('PDF.js library not loaded');
                }

                if (!PDFConfig.getWorkerSrc()) {
                    throw new Error('PDF.js worker not configured');
                }

                // Read the file as array buffer
                const arrayBuffer = await file.arrayBuffer();
                
                // Load the PDF document
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                log(`✅ PDF loaded successfully - ${pdf.numPages} pages`, 'success');

                // Try to render the first page to test worker functionality
                const page = await pdf.getPage(1);
                const viewport = page.getViewport({ scale: 1.0 });
                
                // Get text content to test text extraction
                const textContent = await page.getTextContent();
                const textItems = textContent.items.map(item => item.str).join(' ');
                
                log(`✅ First page rendered successfully (${viewport.width}x${viewport.height})`, 'success');
                log(`✅ Text extraction successful - extracted ${textItems.length} characters`, 'success');

                resultDiv.innerHTML = `
                    <div class="status success">✅ PDF Processing Test Successful</div>
                    <p><strong>File:</strong> ${file.name}</p>
                    <p><strong>Pages:</strong> ${pdf.numPages}</p>
                    <p><strong>First Page Size:</strong> ${viewport.width.toFixed(1)} × ${viewport.height.toFixed(1)}</p>
                    <p><strong>Text Preview:</strong> ${textItems.substring(0, 100)}${textItems.length > 100 ? '...' : ''}</p>
                `;

            } catch (error) {
                log(`❌ PDF processing failed: ${error.message}`, 'error');
                resultDiv.innerHTML = `<div class="status error">❌ PDF Processing Failed: ${error.message}</div>`;
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            log('PDF Worker Configuration Test page loaded', 'info');
            showEnvironmentInfo();
            checkConfiguration();
            showWorkerInfo();

            // Test PDF.js configuration on load
            if (typeof PDFConfig !== 'undefined') {
                PDFConfig.initWorker();
                log('PDF.js worker initialized via PDFConfig', 'success');
            } else {
                log('PDFConfig utility not available', 'warning');
            }
        });
    </script>
</body>
</html>
