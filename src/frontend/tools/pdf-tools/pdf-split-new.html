<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>PDF Split - Split PDF by Pages | ImagePDF Toolkit</title>
    <meta name="description" content="Split PDF files by pages or ranges. Free online PDF splitter tool with custom page selection.">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="../../../../public/styles.min.css?v=2.3.1">
    <link rel="stylesheet" href="../../../../public/tailwind-complete.css?v=2.3.1">
    <link rel="stylesheet" href="../../../../public/css/all.min.css?v=2.3.1">
    <link rel="stylesheet" href="../../../../public/css/premium-buttons.css?v=2.3.1">
    
    <!-- Scripts -->
    <script src="../../../../public/js/pdf.min.js"></script>
    <script src="../../../../public/js/jspdf.min.js"></script>
    <script src="../../../../public/script.js?v=2.3.1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="bg-slate-50 dark:bg-gray-900 text-slate-800 dark:text-gray-100 min-h-screen">
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>
    
    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <a href="../../../../index.html" class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-600 via-purple-600 to-indigo-700 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14z"/>
                            </svg>
                        </div>
                        <span class="text-xl font-bold">ImagePDF Toolkit</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <section class="text-center mb-12">
            <h1 class="text-4xl font-bold mb-4">PDF Split Tool</h1>
            <p class="text-xl text-gray-600 dark:text-gray-300">Split PDF files by pages or custom ranges</p>
        </section>
        
        <!-- File Upload -->
        <div class="max-w-2xl mx-auto mb-8">
            <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center" id="file-drop-zone">
                <input type="file" id="file-input" accept=".pdf" class="hidden">
                <div class="mb-4">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h3 class="text-lg font-medium mb-2">Drop PDF file here</h3>
                <p class="text-gray-500 mb-4">or click to browse</p>
                <button onclick="document.getElementById('file-input').click()" class="btn-base btn-primary">
                    Choose PDF File
                </button>
            </div>
        </div>
        
        <!-- Split Options -->
        <div id="split-options" class="max-w-4xl mx-auto mb-8 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">Split Options</h3>
                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                        <input type="radio" name="split-type" value="individual" checked class="mr-3">
                        <div>
                            <div class="font-medium">Individual Pages</div>
                            <div class="text-sm text-gray-500">Split into separate files for each page</div>
                        </div>
                    </label>
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                        <input type="radio" name="split-type" value="range" class="mr-3">
                        <div>
                            <div class="font-medium">Page Range</div>
                            <div class="text-sm text-gray-500">Extract specific page ranges</div>
                        </div>
                    </label>
                    <label class="flex items-center p-4 border rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                        <input type="radio" name="split-type" value="bulk" class="mr-3">
                        <div>
                            <div class="font-medium">Bulk Split</div>
                            <div class="text-sm text-gray-500">Split into chunks of X pages</div>
                        </div>
                    </label>
                </div>
                
                <!-- Range Options -->
                <div id="range-options" class="hidden mb-4">
                    <label class="block text-sm font-medium mb-2">Page Ranges (e.g., 1-3,5,7-9):</label>
                    <input type="text" id="page-ranges" placeholder="1-3,5,7-9" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                </div>
                
                <!-- Bulk Options -->
                <div id="bulk-options" class="hidden mb-4">
                    <label class="block text-sm font-medium mb-2">Pages per file:</label>
                    <input type="number" id="pages-per-split" value="1" min="1" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                </div>
                
                <div class="text-center">
                    <button id="split-btn" class="btn-base btn-success btn-lg" onclick="splitPDF()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Split PDF
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Processing Status -->
        <div id="processing-status" class="max-w-2xl mx-auto mb-8 hidden">
            <div class="bg-blue-50 dark:bg-blue-900 border border-blue-200 dark:border-blue-700 rounded-lg p-4">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-3"></div>
                    <span>Processing PDF split...</span>
                </div>
            </div>
        </div>
        
        <!-- Results -->
        <div id="results" class="max-w-4xl mx-auto hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <h3 class="text-lg font-semibold mb-4">Split Complete!</h3>
                <div id="results-info" class="mb-4"></div>
                <div class="flex gap-4">
                    <button id="download-btn" class="btn-base btn-success" onclick="downloadResults()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-4-4m4 4l4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        Download Split Files
                    </button>
                    <button class="btn-base btn-secondary" onclick="resetTool()">
                        Split Another PDF
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Error Display -->
        <div id="error-display" class="max-w-2xl mx-auto mb-8 hidden">
            <div class="bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-700 rounded-lg p-4">
                <div class="flex">
                    <svg class="w-5 h-5 text-red-400 mr-3 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"/>
                    </svg>
                    <div>
                        <h3 class="text-sm font-medium text-red-800 dark:text-red-200">Error</h3>
                        <p id="error-message" class="text-sm text-red-700 dark:text-red-300 mt-1"></p>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        // Global variables for PDF split tool
        let pdfSplitTool = {
            currentFile: null,
            totalPages: 0,
            splitResults: null,
            isProcessing: false
        };
        
        // Backend configuration
        const BACKEND_CONFIG = {
            baseUrl: 'https://imagetool-h4dmewahfmg4bkej.eastasia-01.azurewebsites.net',
            endpoints: {
                split: '/pdf-split'
            }
        };
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeFileHandling();
            initializeSplitOptions();
            console.log('PDF Split Tool initialized');
        });
        
        function initializeFileHandling() {
            const fileInput = document.getElementById('file-input');
            const dropZone = document.getElementById('file-drop-zone');
            
            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }
            
            if (dropZone) {
                // Drag and drop handlers
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('border-blue-500', 'bg-blue-50');
                });
                
                dropZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFileSelect({ target: { files } });
                    }
                });
            }
        }
        
        function initializeSplitOptions() {
            const radioButtons = document.querySelectorAll('input[name="split-type"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', updateSplitOptions);
            });
        }
        
        function updateSplitOptions() {
            const selectedType = document.querySelector('input[name="split-type"]:checked')?.value;
            
            const rangeOptions = document.getElementById('range-options');
            const bulkOptions = document.getElementById('bulk-options');
            
            if (rangeOptions) rangeOptions.classList.add('hidden');
            if (bulkOptions) bulkOptions.classList.add('hidden');
            
            if (selectedType === 'range' && rangeOptions) {
                rangeOptions.classList.remove('hidden');
            } else if (selectedType === 'bulk' && bulkOptions) {
                bulkOptions.classList.remove('hidden');
            }
        }
        
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file || !file.type.includes('pdf')) {
                showError('Please select a valid PDF file');
                return;
            }
            
            if (file.size > 100 * 1024 * 1024) { // 100MB limit
                showError('File too large. Maximum size is 100MB');
                return;
            }
            
            pdfSplitTool.currentFile = file;
            
            try {
                // Initialize PDF.js if not already done
                if (typeof pdfjsLib !== 'undefined') {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = '../../../../public/js/pdf.worker.min.js';
                }
                
                // Get PDF info
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                pdfSplitTool.totalPages = pdf.numPages;
                
                const splitOptions = document.getElementById('split-options');
                if (splitOptions) {
                    splitOptions.classList.remove('hidden');
                }
                
                showToast(`PDF loaded: ${pdfSplitTool.totalPages} pages`, 'success');
                
            } catch (error) {
                console.error('Error loading PDF:', error);
                showError(`Failed to load PDF: ${error.message}`);
            }
        }
        
        async function splitPDF() {
            if (!pdfSplitTool.currentFile) {
                showError('Please select a PDF file first');
                return;
            }
            
            if (pdfSplitTool.isProcessing) {
                showError('Split operation already in progress');
                return;
            }
            
            const selectedType = document.querySelector('input[name="split-type"]:checked')?.value;
            let splitConfig = { type: selectedType };
            
            if (selectedType === 'range') {
                const ranges = document.getElementById('page-ranges')?.value.trim();
                if (!ranges) {
                    showError('Please specify page ranges');
                    return;
                }
                splitConfig.ranges = ranges;
            } else if (selectedType === 'bulk') {
                const pagesPerSplit = parseInt(document.getElementById('pages-per-split')?.value || '1');
                if (pagesPerSplit < 1) {
                    showError('Pages per split must be at least 1');
                    return;
                }
                splitConfig.pages_per_split = pagesPerSplit;
            }
            
            pdfSplitTool.isProcessing = true;
            showProcessingStatus();
            hideError();
            
            try {
                // Try backend first
                const success = await tryBackendSplit(splitConfig);
                if (!success) {
                    // Fallback to client-side
                    showToast('Backend unavailable, using client-side processing...', 'info');
                    await clientSideSplit(splitConfig);
                }
                
            } catch (error) {
                console.error('Split error:', error);
                showError(`Split failed: ${error.message}`);
            } finally {
                pdfSplitTool.isProcessing = false;
                hideProcessingStatus();
            }
        }
        
        async function tryBackendSplit(config) {
            try {
                const formData = new FormData();
                formData.append('file', pdfSplitTool.currentFile);
                formData.append('type', config.type);
                
                if (config.ranges) {
                    formData.append('ranges', config.ranges);
                } else if (config.pages_per_split) {
                    formData.append('pages_per_split', config.pages_per_split);
                }
                
                const response = await fetch(`${BACKEND_CONFIG.baseUrl}${BACKEND_CONFIG.endpoints.split}`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const filename = response.headers.get('content-disposition')?.match(/filename="(.+)"/)?.[1] || 'split_files.zip';
                    
                    pdfSplitTool.splitResults = { blob, filename, backend: true };
                    showResults(response.headers);
                    showToast('PDF split completed successfully!', 'success');
                    return true;
                } else {
                    console.warn('Backend returned error:', response.status);
                }
                
            } catch (error) {
                console.warn('Backend split failed:', error);
            }
            return false;
        }
        
        async function clientSideSplit(config) {
            try {
                const arrayBuffer = await pdfSplitTool.currentFile.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                
                if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                    throw new Error('jsPDF library not loaded');
                }
                
                const { jsPDF } = window.jspdf;
                let filesToZip = [];
                
                if (config.type === 'individual') {
                    // Split into individual pages
                    for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                        const blob = await createSinglePagePDF(pdf, pageNum, jsPDF);
                        filesToZip.push({
                            name: `page_${pageNum}.pdf`,
                            blob: blob
                        });
                    }
                } else if (config.type === 'range') {
                    // Parse ranges and create files
                    const ranges = parsePageRanges(config.ranges, pdf.numPages);
                    for (let i = 0; i < ranges.length; i++) {
                        const [start, end] = ranges[i];
                        const blob = await createRangePDF(pdf, start, end, jsPDF);
                        const filename = start === end ? `page_${start}.pdf` : `pages_${start}-${end}.pdf`;
                        filesToZip.push({ name: filename, blob: blob });
                    }
                } else if (config.type === 'bulk') {
                    // Split into chunks
                    const pagesPerChunk = config.pages_per_split;
                    for (let start = 1; start <= pdf.numPages; start += pagesPerChunk) {
                        const end = Math.min(start + pagesPerChunk - 1, pdf.numPages);
                        const blob = await createRangePDF(pdf, start, end, jsPDF);
                        const filename = start === end ? `page_${start}.pdf` : `pages_${start}-${end}.pdf`;
                        filesToZip.push({ name: filename, blob: blob });
                    }
                }
                
                // Create ZIP file
                if (typeof JSZip === 'undefined') {
                    throw new Error('JSZip library not loaded');
                }
                
                const zip = new JSZip();
                filesToZip.forEach(file => {
                    zip.file(file.name, file.blob);
                });
                
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const filename = pdfSplitTool.currentFile.name.replace('.pdf', '_split.zip');
                
                pdfSplitTool.splitResults = { blob: zipBlob, filename, client: true };
                showResults();
                showToast(`Successfully split into ${filesToZip.length} files!`, 'success');
                
            } catch (error) {
                console.error('Client-side split error:', error);
                throw error;
            }
        }
        
        async function createSinglePagePDF(pdf, pageNum, jsPDF) {
            const page = await pdf.getPage(pageNum);
            const viewport = page.getViewport({ scale: 1.5 });
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            
            await page.render({ canvasContext: context, viewport }).promise;
            
            const newPdf = new jsPDF({
                orientation: viewport.width > viewport.height ? 'landscape' : 'portrait',
                unit: 'pt',
                format: [viewport.width, viewport.height]
            });
            
            const imgData = canvas.toDataURL('image/jpeg', 0.95);
            newPdf.addImage(imgData, 'JPEG', 0, 0, viewport.width, viewport.height);
            
            return newPdf.output('blob');
        }
        
        async function createRangePDF(pdf, startPage, endPage, jsPDF) {
            const newPdf = new jsPDF();
            let isFirstPage = true;
            
            for (let pageNum = startPage; pageNum <= endPage; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale: 1.5 });
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                await page.render({ canvasContext: context, viewport }).promise;
                
                if (!isFirstPage) {
                    newPdf.addPage();
                }
                
                const imgData = canvas.toDataURL('image/jpeg', 0.95);
                newPdf.addImage(imgData, 'JPEG', 0, 0, newPdf.internal.pageSize.getWidth(), newPdf.internal.pageSize.getHeight());
                
                isFirstPage = false;
            }
            
            return newPdf.output('blob');
        }
        
        function parsePageRanges(rangeString, totalPages) {
            const ranges = [];
            const parts = rangeString.split(',');
            
            for (const part of parts) {
                const trimmed = part.trim();
                if (trimmed.includes('-')) {
                    const [start, end] = trimmed.split('-').map(n => parseInt(n.trim()));
                    if (start >= 1 && end <= totalPages && start <= end) {
                        ranges.push([start, end]);
                    }
                } else {
                    const pageNum = parseInt(trimmed);
                    if (pageNum >= 1 && pageNum <= totalPages) {
                        ranges.push([pageNum, pageNum]);
                    }
                }
            }
            
            return ranges;
        }
        
        function showResults(headers = null) {
            const resultsDiv = document.getElementById('results');
            const resultsInfo = document.getElementById('results-info');
            
            if (!resultsDiv || !resultsInfo) return;
            
            let info = 'PDF split completed successfully!';
            if (headers) {
                const totalPages = headers.get('X-Total-Pages');
                const splitCount = headers.get('X-Split-Count');
                if (totalPages && splitCount) {
                    info = `Split ${totalPages} pages into ${splitCount} files`;
                }
            }
            
            resultsInfo.textContent = info;
            resultsDiv.classList.remove('hidden');
        }
        
        function downloadResults() {
            if (!pdfSplitTool.splitResults) {
                showError('No split results available for download');
                return;
            }
            
            try {
                const url = URL.createObjectURL(pdfSplitTool.splitResults.blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = pdfSplitTool.splitResults.filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showToast('Download started', 'success');
            } catch (error) {
                console.error('Download error:', error);
                showError('Failed to download files');
            }
        }
        
        function resetTool() {
            pdfSplitTool.currentFile = null;
            pdfSplitTool.totalPages = 0;
            pdfSplitTool.splitResults = null;
            pdfSplitTool.isProcessing = false;
            
            const elements = {
                'split-options': true,
                'results': true,
                'file-input': 'value',
                'page-ranges': 'value',
                'pages-per-split': 'value'
            };
            
            Object.keys(elements).forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    if (elements[id] === true) {
                        el.classList.add('hidden');
                    } else if (elements[id] === 'value') {
                        el.value = id === 'pages-per-split' ? '1' : '';
                    }
                }
            });
            
            // Reset radio button
            const individualRadio = document.querySelector('input[name="split-type"][value="individual"]');
            if (individualRadio) {
                individualRadio.checked = true;
                updateSplitOptions();
            }
            
            hideError();
        }
        
        function showProcessingStatus() {
            const el = document.getElementById('processing-status');
            if (el) el.classList.remove('hidden');
        }
        
        function hideProcessingStatus() {
            const el = document.getElementById('processing-status');
            if (el) el.classList.add('hidden');
        }
        
        function showError(message) {
            const errorEl = document.getElementById('error-message');
            const displayEl = document.getElementById('error-display');
            
            if (errorEl) errorEl.textContent = message;
            if (displayEl) displayEl.classList.remove('hidden');
        }
        
        function hideError() {
            const el = document.getElementById('error-display');
            if (el) el.classList.add('hidden');
        }
        
        function showToast(message, type = 'info', duration = 3000) {
            if (typeof window.showToast === 'function') {
                window.showToast(message, type, duration);
            } else {
                console.log(`Toast (${type}): ${message}`);
            }
        }
    </script>
</body>
</html>
